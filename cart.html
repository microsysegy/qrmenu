<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙØ§ØªÙˆØ±ØªÙƒ - Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†</title>
<style>
body { font-family:Tahoma, sans-serif; background:#f5f5f5; color:#222; margin:0; padding:20px; }
h2 { text-align:center; margin-bottom:20px; }
.cart-item { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#fff; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
.cart-item img { width:80px; height:80px; object-fit:cover; border-radius:8px; margin-left:10px; }
.cart-item div { flex:1; }
button { font-size:14px; font-weight:bold; padding:5px 10px; border:none; border-radius:6px; cursor:pointer; background:#d62828; color:#fff; margin:2px; }
button:hover { background:#ff6f3c; }
#total { font-weight:bold; margin-top:15px; text-align:right; font-size:16px; }
.empty-msg { text-align:center; margin-top:50px; font-size:16px; color:#555; }
</style>
</head>
<body>

<h2>ÙØ§ØªÙˆØ±ØªÙƒ</h2>
<div id="cartContainer"></div>
<div id="total"></div>
<div style="text-align:center; margin-top:20px;">
    <button onclick="clearCart()">Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <button onclick="sendToWhatsApp()">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ WhatsApp</button>
    <button onclick="window.location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ÙŠÙˆ</button>
</div>

<script>
let CART = JSON.parse(localStorage.getItem("CART") || "{}");
let CACHE = JSON.parse(localStorage.getItem("OFFLINE_MENU") || "{}"); 

function saveCart(){
    localStorage.setItem("CART", JSON.stringify(CART));
}

function renderCart(){
    const container = document.getElementById("cartContainer");
    container.innerHTML = "";

    if(Object.keys(CART).length === 0){
        container.innerHTML = '<div class="empty-msg">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
        document.getElementById("total").textContent = "";
        return;
    }

    let total = 0;

    Object.values(CART).forEach((c, index)=>{
        let itemData = null;
        for(let catId in CACHE.items){
            const found = CACHE.items[catId].find(i=>i.id==c.itemId);
            if(found){ itemData = found; break; }
        }
        const imgSrc = itemData?.itemImg?.length>50 ? `data:image/jpeg;base64,${itemData.itemImg}` : "noimage.png";

        const itemTotal = c.qty * c.price;
        total += itemTotal;
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
            <img src="${imgSrc}" />
            <div>
                <strong>${c.itemName} - ${c.unitName}</strong>
                <div>
                    <span id="qty-${index}">${c.qty}</span>
                </div>
                <div>${itemTotal} Ø¬Ù†ÙŠÙ‡</div>
            </div>
        `;
console.log('b'+c.qty);
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        const controls = document.createElement("div");
        const btnMinus = document.createElement("button");
        btnMinus.textContent = "-";
        btnMinus.addEventListener("click", ()=> updateQty(c.itemId, c.unitName, -1));

        const btnPlus = document.createElement("button");
        btnPlus.textContent = "+";
        btnPlus.addEventListener("click", ()=> updateQty(c.itemId, c.unitName, 1));

        const btnRemove = document.createElement("button");
        btnRemove.textContent = "Ø­Ø°Ù";
        btnRemove.addEventListener("click", ()=> removeItem(c.itemId, c.unitName));

        controls.appendChild(btnMinus);
        controls.appendChild(btnPlus);
        controls.appendChild(btnRemove);

        div.querySelector("div").appendChild(controls);

        container.appendChild(div);
    });

    document.getElementById("total").textContent = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + total + " Ø¬Ù†ÙŠÙ‡";
}

function updateQty(itemId, unitName, delta){
    const key = `${itemId}-${unitName}`;
    if(!CART[key]) return;
    CART[key].qty += delta;
    if(CART[key].qty <= 0) delete CART[key];
    saveCart();
    renderCart();
}

function removeItem(itemId, unitName){
    const key = `${itemId}-${unitName}`;
    delete CART[key];
    saveCart();
    renderCart();
}

function clearCart(){
    CART = {};
    saveCart();
    renderCart();
}

function sendToWhatsApp(){
    if(Object.keys(CART).length===0){
        alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
        return;
    }

    let msg = "ğŸ§¾ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯:\n\n";
    let total = 0;

    Object.values(CART).forEach(c=>{
        const itemData = (()=>{for(let catId in CACHE.items){ const f = CACHE.items[catId].find(i=>i.id==c.itemId); if(f) return f; } return null;})();
        const lineTotal = c.qty * c.price;
        total += lineTotal;
        const imgLink = itemData?.itemImg?.length>50 ? "[ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©]" : "";
        msg += `â€¢ ${c.itemName}\n  - ${c.unitName} Ã— ${c.qty} = ${lineTotal} Ø¬Ù†ÙŠÙ‡ ${imgLink}\n\n`;
    });

    msg += `ğŸ”» Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬Ù†ÙŠÙ‡`;
    const phone = "+201001741790"; 
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
}

// Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
renderCart();
</script>

</body>
</html>
