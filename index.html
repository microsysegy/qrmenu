<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<script src="offline-data.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ÙŠÙˆ Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†</title>
<style>
/* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
@font-face {
    font-family: "cairo";
    src: url("adobe-arabic-regular.otf") format("truetype");
    font-weight: normal;
    font-style: normal;
}

@font-face {
    font-family: "moh";
    src: url("al-mohanad.ttf") format("truetype");
    font-weight: bold;
    font-style: normal;
}
.badge {
  position: absolute;
  top: 8px;
  right: 10px;
  width: 12px;
  height: 12px;
  background: #0cb344;
  border-radius: 50%;
  display: none;
}
body { margin:0; font-family:Tahoma, sans-serif; background:#f5f5f5; color:#222; }
.categories-bar.sticky {
    position: fixed; /* ØªØµØ¨Ø­ Ø«Ø§Ø¨ØªØ© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© */
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}
.footercard{ 
    display: flex;
    align-items: center;
    color: #d62828;
    padding-right:7px ;
    justify-content: space-between; /* ØªØ¬Ø¹Ù„ Ø§Ù„Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù */
}
    .header-cover {
    position: relative;
    height: 140px;
    background: url("noimage.png") center / cover no-repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.header-cover h1 {
    position: relative;
    color: #fff;
    font-size: 25px;
    z-index: 2;
    text-shadow: 0 2px 6px rgba(0,0,0,.6);
}

/* Ø·Ø¨Ù‚Ø© ØªØºÙ…ÙŠÙ‚ */
.header-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1;
}
#categories-placeholder {
  height: 0;
}
.categories-bar {background-color: white;    position:relative; display:flex; overflow-x:auto; gap:15px; padding:5px;  border-bottom:1px solid ;}
.category {font-size: 14px;font-weight:bold;background: #f5f5f5; border:1px solid; border-color:#d62828; color:#d62828; padding:7px 15px; border-radius:10px; cursor:pointer; white-space:nowrap; }
.category:hover { background:#d62828;color: #f5f5f5; }
.items { font-size: 14px;font-weight:bold;text-align:right; display:flex; flex-wrap: wrap; gap:20px; margin:20px; justify-content:center; }
.item { text-align:right; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:150px; cursor:pointer; transition:0.25s; }
.item:hover { transform:scale(1.03); }
.item img { width:100%; height:140px; object-fit:contain; }
.info {font-size: 14px;font-weight:bold; padding:5px; text-align:right; }
.details {flex: 1; font-size: 12px; padding:10px;font-weight: normal;text-align: right;padding: 0px; padding-bottom:5px ; }
.details-popup, .cart-popup {font-size: 14px;font-weight:bold; display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
.details-content, .cart-content { font-size: 14px;font-weight:bold;background:#fff; padding:20px; border-radius:12px; max-width:400px; width:90%; max-height:80%; overflow-y:auto; }
.unit-item, .cart-item {font-size: 14px; font-weight:bold;margin:10px 0; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.2); display:flex; align-items:center; justify-content:space-between; }
.unit-item img, .cart-item img { width:60px; height:60px; object-fit:cover; border-radius:8px; margin-left:10px; }
#okBtn{font-size: 14px; font-weight:bold;width:100%; background:#d62828; color:#fff; padding:8px; border:none; border-radius:10px; margin-top:10px; cursor:pointer; }
#clearCartBtn, #sendWhatsappBtn {font-size: 14px;font-weight:bold; width:100%;border-color:#d62828; color:#d62828; padding:8px; border:1px solid; border-radius:10px; margin-top:10px; cursor:pointer; }
.footer a{text-decoration: none; font-size: 14px; font-weight:bold;background:#222; color:#fff; text-align:center; padding:8px; position:fixed; bottom:0; width:100%; margin-top: 30px;}
#cartBtn {font-size: 14px;font-weight:bold; position:fixed; bottom:80px; left:20px; background:#d62828; color:white; border:none; border-radius:50px; width:60px; height:60px; font-size:24px; cursor:pointer; z-index:2000; }
.quantity-control { display:flex; gap:5px; align-items:center; }
.quantity-control button { width:50px; height:25px; background:#d62828; color:white; border:none; border-radius:5px; cursor:pointer; }
.unit-item button {font-size: 14px;font-weight:bold;
    background: #d62828;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 20px;
    cursor: pointer;
    transition: 0.2s;
}

.unit-item button:hover {
    background: #ff6f3c;
}

#okBtn:hover {
    background: #005fa3;
}

.view{font-size: 14px;
  font-weight: bold;  
  background: #d62828;
    color: #fff;
    border: none;
    border-radius: 30px;
    padding: 5px 13px;
    margin: 7px;
    cursor: pointer;
    transition: 0.2s;
}
/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ§Ø±Øª */
.cart-item button{font-size: 14px;
    background: #d62828;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 5px 13px;
    cursor: pointer;
    transition: 0.2s;
}

.cart-item button:hover {
    background: #ff6f3c;
}
.categories-bar {
  position: sticky;
  top: 0;
  z-index: 1000;
}
</style>
</head>
<body>

<header class="header-cover" onclick="manualRefresh()">
    <div class="header-overlay"></div>
    <h1>Ù…Ø·Ø¹Ù… Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†</h1>
</header>
<div class="categories-bar" id="menu"></div>
<div id="categories-placeholder"></div>
<div id="itemsContainer" class="items"></div>

<!-- Popup Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
<div class="details-popup" id="detailsPopup">
    <div class="details-content" id="detailsContent">
            <button id="okBtn" onclick="closePopup()">Ù…ÙˆØ§ÙÙ‚</button>
</div>
</div>

<!-- Popup Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div class="cart-popup" id="cartPopup">
    <div class="cart-content">
        <h3>ÙØ§ØªÙˆØ±ØªÙƒ</h3>
        <div id="cartItems"></div>
        <button id="sendWhatsappBtn" onclick="sendToWhatsApp()">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ WhatsApp</button>
        <button id="clearCartBtn" onclick="">Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            <button id="okBtn" onclick="closeCart()">Ù…ÙˆØ§ÙÙ‚</button>
        
    </div>
</div>

<button id="cartBtn" onclick="goToCart()">ğŸ›’  <span id="cartBadge" class="badge"></span>
</button>

<footer class="footer" ><a href="https://microsysegy.github.io/web">Â© 2025 MicrosysEgypt.com</a></button></footer>

<script src="cart-storage.js"></script>
<script>
let CART = loadCart(); // âœ… Ø¨Ø¯ÙˆÙ† timeout

</script>

<script>
const API = "http://192.168.1.2:5000/api";
let CACHE = null;

// Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
//let CART = JSON.parse(localStorage.getItem("CART") || "{}");
function saveCart(){
    const data = {
        cart: CART,
        time: Date.now()
    };
    localStorage.setItem("CART_SESSION", JSON.stringify(data));
}
// ==================== INIT ====================
document.addEventListener("DOMContentLoaded", async () => {
  //const ok = await loadOnline();
  //if(!ok) loadOffline();
  loadOffline();
  renderItems(1)
});

// ==================== ONLINE ====================
async function fetchJSON(url){
    const c = new AbortController();
    setTimeout(()=>c.abort(),5000);
    const res = await fetch(url,{signal:c.signal});
    if(!res.ok) throw "API Error";
    return res.json();
}

async function loadOnline(){
    try{
        const categories = await fetchJSON(`${API}/Categories?formid=7`);
        const items = {};
        const units = {};
        for(const c of categories){
            items[c.id] = await fetchJSON(`${API}/Items/ByCategory/${c.id}`);
            for(const i of items[c.id]){
                units[i.id] = await fetchJSON(`${API}/Items/${i.id}/Units`);
            }
        }
        CACHE = {categories, items, units};
        localStorage.setItem("OFFLINE_MENU", JSON.stringify(CACHE));
        //exportToJSON()
        renderCategories();
        return true;
    }catch(e){
        console.log("API unavailable, using Offline", e);
        return false;
    }
}

// ==================== OFFLINE ====================
function loadOffline(){
    const raw = localStorage.getItem("OFFLINE_MENU");
    CACHE = raw ? JSON.parse(raw) : OFFLINE_DATA;
    renderCategories();
}

// ==================== RENDER ====================
function renderCategories(){
    const menu = document.getElementById("menu");
    menu.innerHTML="";
    CACHE.categories.forEach(c=>{
        const d = document.createElement("div");
        d.className="category";
        d.textContent=c.nameA;
        d.onclick=()=>renderItems(c.id);
        menu.appendChild(d);
    });
}

function renderItems(catId){
    const box = document.getElementById("itemsContainer");
    box.innerHTML="";
    (CACHE.items[catId]||[]).forEach(i=>{
        const img = i.itemImg?.length>50 ? `data:image/jpeg;base64,${i.itemImg}` : "noimage.png";
          // âœ… Ø³Ø¹Ø± Ø£ÙˆÙ„ ÙˆØ­Ø¯Ø©
        const firstUnit = (CACHE.units[i.id] && CACHE.units[i.id].length > 0)
            ? CACHE.units[i.id][0].price
            : null;
        const priceHtml = firstUnit
            ? `<div class="price"> ${firstUnit} Ø¬</div>`
            : `<div class="price">â€”</div>`;
        const d = document.createElement("div");
        d.className="item";
        d.innerHTML=`<img src="${img}"><div class="info">${i.nameA}</div><div class="details">Ø¬Ø±Ø¨ ${i.nameA}</div><div class="footercard">${priceHtml}<button class="view">Ø¹Ø±Ø¶</button></div>`;
d.onclick = () => {
  localStorage.setItem("selectedItem", JSON.stringify({
    item: i,
    units: CACHE.units[i.id] || []
  }));

  const encoded = encodeURIComponent(i.itemImg);
    // ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    window.location.href = `item.html`;
};

        box.appendChild(d);
    });
}

function showUnits(itemId, itemName){
    let html = `<h3 style="text-align:center;margin-bottom:15px;">${itemName}</h3>`;
    (CACHE.units[itemId]||[]).forEach(u=>{
        const img = u.image?.length>50 ? `<img src="data:image/jpeg;base64,${u.image}" style="width:100%;height:90px;object-fit:cover;border-radius:8px;margin-bottom:6px;">` : "";

        html += `
        <div class="unit-item" style="display:flex; flex-direction:column; align-items:center; padding:10px; margin-bottom:10px; background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15); width:100%;">
            ${img}
            <div style="font-weight:bold; margin:5px 0;">${u.unitName} - ${u.price} Ø¬Ù†ÙŠÙ‡</div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:5px;">
                <button onclick="changeUnitQty(${itemId}, \`${itemName}\`, \`${u.unitName}\`, ${u.price}, -1)">-</button>
                <span id="unit-qty-${itemId}-${u.unitName}">${CART[`${itemId}-${u.unitName}`]?.qty||0}</span>
                <button onclick="changeUnitQty(${itemId}, \`${itemName}\`, \`${u.unitName}\`, ${u.price}, 1)">+</button>
            </div>
        </div>`;
    });

    html += `<button id="okBtn" onclick="closePopup()" style="width:100%; background:#d62828; color:white; padding:8px; border:none; border-radius:10px; font-size:14px;font-weight:bold; margin-top:15px;">Ù…ÙˆØ§ÙÙ‚</button>`;

    document.getElementById("detailsContent").innerHTML = html;
    document.getElementById("detailsPopup").style.display = "flex";
}

// ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
function changeUnitQty(itemId, itemName, unitName, price, delta){
    const key = `${itemId}-${unitName}`;
    if(!CART[key]) CART[key] = {itemId, itemName, unitName, price, qty:0};

    CART[key].qty += delta;

    if(CART[key].qty <= 0){
        delete CART[key];
        document.getElementById(`unit-qty-${itemId}-${unitName}`).textContent = 0;
    } else {
        document.getElementById(`unit-qty-${itemId}-${unitName}`).textContent = CART[key].qty;
    }

    saveCart(); // âœ… Ù…Ù‡Ù…
}

//            <button onclick="changeQty(${itemId}, '${u.unitName}', -1)">  -  </button>
//            <span id="qty-${itemId}-${u.unitName}">0</span>
//            <button onclick="changeQty(${itemId}, '${u.unitName}', 1)">  +  </button>
//            <button onclick="addToCart(${itemId}, '${u.unitName}', ${u.price})">   Ø¥Ø¶Ø§ÙØ©   </button>


// ==================== CART ====================
function closePopup(){ document.getElementById("detailsPopup").style.display="none"; }
function manualRefresh(){ loadOnline().then(ok=>{if(!ok) alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");}); }
function goToCart(){
    // Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø±Øª ÙÙŠ localStorage (Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹)
    saveCart();
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ø±Øª
    window.location.href = "cart.html";
}

function changeQty(itemId, unitName, delta){
    const key = `${itemId}-${unitName}`;
    let val = CART[key]?.qty || 0;
    val += delta;
    if(val<0) val=0;
    document.getElementById(`qty-${itemId}-${unitName}`).textContent = val;
    if(val===0) delete CART[key];
    else CART[key] = {...CART[key], qty:val};
}

function addToCart(itemId, itemName, unitName, price){
    const key = `${itemId}-${unitName}`;
    CART[key] = {
        itemId,
        itemName,
        unitName,
        price,
        qty: (CART[key]?.qty || 0) + 1
    };

    // âœ… Ø§Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¨Ø© ÙÙˆØ±Ù‹Ø§
    localStorage.setItem("CART", JSON.stringify(CART));

    // âœ… Ø­Ø¯Ù‘Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯
    const qtyEl = document.getElementById(`qty-${itemId}-${unitName}`);
    if (qtyEl) {
        qtyEl.textContent = CART[key].qty;
    }
}

function openCart(){
    const container = document.getElementById("cartItems");
    container.innerHTML = "";
    let total = 0;

    Object.values(CART).forEach(c=>{
        const itemTotal = c.price * c.qty;
        total += itemTotal;

        container.innerHTML += `
        <div class="cart-item" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:5px; border-bottom:1px solid #ccc;">
            <div style="flex:1;">
                <strong>${c.itemName} - ${c.unitName}</strong>
                <div style="display:flex; align-items:center; gap:5px; margin-top:3px;">
                    <button onclick="updateQty('${c.itemId}','${c.unitName}',-1)">-</button>
                    <span id="cart-qty-${c.itemId}-${c.unitName}">${c.qty}</span>
                    <button onclick="updateQty('${c.itemId}','${c.unitName}',1)">+</button>
                </div>
            </div>
            <div style="text-align:right;">
                <span>${itemTotal} Ø¬Ù†ÙŠÙ‡</span><br>
                <button onclick="removeFromCart('${c.itemId}','${c.unitName}')" style="margin-top:3px;">Ø­Ø°Ù</button>
            </div>
        </div>`;
    });

    container.innerHTML += `
        <hr>
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:5px;">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span id="cart-total">${total} Ø¬Ù†ÙŠÙ‡</span>
        </div>`;

    document.getElementById("cartPopup").style.display = "flex";
}

// Ø²ÙŠØ§Ø¯Ø© Ø£Ùˆ Ù†Ù‚Øµ Ø§Ù„ÙƒÙ…ÙŠØ©
function updateQty(itemId, unitName, delta){
    const key = `${itemId}-${unitName}`;
    if(!CART[key]) return;

    CART[key].qty += delta;
    if(CART[key].qty <= 0){
        delete CART[key];
    }

    saveCart(); // âœ…
    openCart();
}

// Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ù…Ø¨Ø§Ø´Ø±Ø©
function removeFromCart(itemId, unitName){
    const key = `${itemId}-${unitName}`;
    delete CART[key];
    saveCart();
    openCart();
}

// Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ø±Øª
function closeCart(){
    document.getElementById("cartPopup").style.display="none";}




function sendToWhatsApp(){
if (Object.keys(CART).length === 0) {
    alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
    return;
}


    let total = 0;
    let msg = "ğŸ§¾ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯:\n\n";

    Object.values(CART).forEach(c => {
        const lineTotal = c.price * c.qty;
        total += lineTotal;

        msg += `â€¢ ${c.itemName}\n`;
        msg += `  - ${c.unitName} Ã— ${c.qty} = ${lineTotal} Ø¬Ù†ÙŠÙ‡\n\n`;
    });

    msg += `ğŸ”» Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬Ù†ÙŠÙ‡`;

    const phone = "+201001741790"; // Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

    window.open(url, "_blank");
}

function exportToJSON() {
    if (!CACHE) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
        return;
    }

    const dataStr = JSON.stringify(CACHE, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "offline.json";
    a.click();

    URL.revokeObjectURL(url);
}

window.addEventListener("DOMContentLoaded", () => {
  const pending = localStorage.getItem("ADD_TO_CART");

  if (pending) {
    const item = JSON.parse(pending);

    addToCart(
      item.itemId,
      item.itemName,
      item.unitName,
      item.price
    );

    localStorage.removeItem("ADD_TO_CART");
  }
});
window.addEventListener("beforeunload", () => {
  saveCart();
});
const categories = document.querySelector('.categories-bar');
const placeholder = document.getElementById('categories-placeholder');

const barHeight = categories.offsetHeight;
let headerHeight = barHeight + 'px';

window.addEventListener('scroll', () => {
  if (window.scrollY >= headerHeight) {
    categories.classList.add('sticky');
    placeholder.style.height = barHeight + 'px'; // ÙŠØ­Ø¬Ø² Ø§Ù„Ù…ÙƒØ§Ù†
  } else {
    categories.classList.remove('sticky');
    placeholder.style.height = '0px';
  }
});
function markCartChanged() {
  const badge = document.getElementById("cartBadge");
  badge.style.display = "block";
}

// Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø¯Ù„ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…



</script>
 </body>
</html>
<!--#d62828 Ø§Ø­Ù…Ø± 