<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>تفاصيل الصنف</title>
<style>
body { margin:0; font-family:Tahoma; background:#f5f5f5; padding-bottom:90px }
.top-bar button {
  background:none;
  border:none;
  color:#630404;
  
  font-size:25px;
  font-weight:bold;
  cursor:pointer;
}
.top-bar {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:55px;
  background:#e4dcdc;
  color:#630404;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  z-index:2000;
}
body {
  padding-top:55px;
  padding-bottom:90px;
}
/* الصورة الرئيسية */
.header-img {
  width:100%;
  height:230px;
  object-fit:contain;
}

/* اسم الصنف */
.item-name {
  font-size:17px;
  font-weight:bold;
  margin:10px;
  text-align:center;
}

/* الوحدات */
.units {
  display:grid;
  gap:12px;
  padding:15px;
}

.units[data-count="1"] { grid-template-columns:1fr }
.units[data-count="2"] { grid-template-columns:repeat(2,1fr) }
.units[data-count="3"] { grid-template-columns:repeat(3,1fr) }

.unit {
  text-align: center;
  border-radius:20px;
  padding:8px;
  cursor:pointer;
  border:2px solid transparent;
  transition:0.2s;
}

.unit.selected img{
  border-color:#d62828;
  background:#d62828;
}

.unit img {
text-align: center;
  height:70px;
  object-fit:contain;
  border-radius:100vh;
}

.unit-name { font-weight:normal; margin-top:6px; text-align:center;font-size: 14px;}
.unit-price { color:#007706; font-weight:normal; text-align:center ;font-size: 14px;}

/* الشريط السفلي */
.bottom-bar {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  border-top:2px solid #d62828;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.bottom-bar button {
  background:#d62828;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}

.qty {
  font-size:18px;
  font-weight:bold;
  min-width:30px;
  text-align:center;
}
</style>
<div class="top-bar">
  <button onclick="goBack()">← </button>
  <div class="cart-icon" onclick="goToCart()">
  </div>
</div>
</head>
<body>

  <img id="mainImg" class="header-img">
<div id="itemName" class="item-name"></div>

<div id="unitsBox" class="units"></div>

<!-- شريط التحكم السفلي -->
<div class="bottom-bar">
  <button onclick="changeQty(-1)">➖</button>
  <span id="qty" class="qty">0</span>
  <button onclick="changeQty(1)">➕</button>

  <button style="flex:1" onclick="sendToCart()">إرسال للعربة</button>
</div>


<script>
  // استرجاع سلة المشتريات من LocalStorage
let CART = JSON.parse(localStorage.getItem("CART") || "{}");

// دالة لحفظ التغييرات
function saveCart() {
    localStorage.setItem("CART", JSON.stringify(CART));
}
const raw = localStorage.getItem("selectedItem");
if (!raw) location.href = "index.html";

const data = JSON.parse(raw);

// بيانات الصنف
const imgSrc = data.item.itemImg?.length > 50
  ? `data:image/jpeg;base64,${data.item.itemImg}`
  : "noimage.png";

document.getElementById("mainImg").src = imgSrc;
document.getElementById("itemName").textContent = data.item.nameA;

// العربة
//let CART = JSON.parse(localStorage.getItem("CART") || "{}");

// الحالة الحالية
let selectedUnit = null;
let qty = 0;

// الوحدات
const units = data.units || [];
const box = document.getElementById("unitsBox");
box.dataset.count = units.length;

units.forEach(u => {
  const div = document.createElement("div");
  div.className = "unit";
  div.innerHTML = `
    <img src="${imgSrc}">
    <div class="unit-name">${u.unitName}</div>
    <div class="unit-price">${u.price} جنيه</div>
  `;

  div.onclick = () => selectUnit(u, div);
  box.appendChild(div);
});

function selectUnit(unit, el){
  document.querySelectorAll(".unit").forEach(u => u.classList.remove("selected"));
  el.classList.add("selected");

  selectedUnit = unit;

  const key = `${data.item.id}-${unit.unitName}`;
  qty = CART[key]?.qty || 1;

  document.getElementById("qty").textContent = qty;
}

function changeQty(delta){
  if(!selectedUnit) return alert("اختر الوحدة أولاً");
  qty += delta;
  if(qty < 1) qty = 1;
  document.getElementById("qty").textContent = qty;
}
function sendToCart(){
    if(!selectedUnit){
        alert("اختر الوحدة");
        return;
    }

    // تجهيز البيانات
    const payload = {
        itemId: data.item.id,
        itemName: data.item.nameA,
        unitName: selectedUnit.unitName,
        price: selectedUnit.price,
        qty: qty,   // الكمية الحالية
        img: data.item.itemImg
    };

    const key = `${payload.itemId}-${payload.unitName}`;

    // إضافة أو تحديث العنصر في CART
    if(!CART[key]){
        CART[key] = payload;
    } else {
        // إذا الصنف موجود مسبقاً، نجمع الكميات
        CART[key].qty += payload.qty;
    }

    // حفظ السلة
    saveCart();

    // الانتقال مباشرة لصفحة الكارت (أو index.html)
    window.location.href = "cart.html"; // أو "index.html" حسب مسار الكارت
}

function goBack(){
  window.location.href = "index.html";
}
function sendToCart1(){
  if(!selectedUnit){
    alert("اختر الوحدة");
    return;
  }

  // تجهيز نفس الداتا اللي index متعود عليها
  const payload = {
    itemId: data.item.id,
    itemName: data.item.nameA,
    unitName: selectedUnit.unitName,
    price: selectedUnit.price,
    qty: qty,
    img: data.item.itemImg
  };

  // نخزنها مؤقتًا
  localStorage.setItem("ADD_TO_CART", JSON.stringify(payload));

  // رجوع مباشر لصفحة الفاتورة
  window.location.href = "index.html";
}

</script>


</body>
</html>
