<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙØ§ØµÙŠÙ„</title>
<style>
.addspan{padding-right:  10px;color: #9b9a9a;}
.addons-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 18px;
    margin-top: 10px;
    padding-bottom: 70px;

}

.addon-card {
  color: white;
    position: relative;
    background: #d62828;
    border-radius: 18px;
    padding-top: 35px;
    box-shadow: 0 10px 22px rgba(0,0,0,.15);
    overflow: visible;
    cursor: pointer;
    transition: 0.2s;
}

.addon-card.selected {
    outline: 5px solid #007706;
}

.addon-img {
    position: absolute;
    top: -35px;
    left: 50%;
    transform: translateX(-50%);
    width: 75%;
    z-index: 1;
}

.addon-img img {
    width: 100%;
    height: 70px;
    object-fit: contain;
    background: transparent;
    filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
}

.addon-body {
    text-align: center;
    padding: 10px;
}

.addon-name {
    font-weight: bold;
    font-size: 14px;
}

.addon-price {
    color: #1a9c3c;
    font-size: 13px;
    margin-top: 4px;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  50% { transform: translateX(3px); }
  75% { transform: translateX(-3px); }
  100% { transform: translateX(0); }
}
.item-Price{color: #007706;font-size: 20px;}
.cart-animate {
  animation: shake 0.4s;
}


.badge {
  position: absolute;
  top: 8px;
  right: 10px;
  width: 12px;
  height: 12px;
  background: #00ff6a;
  border-radius: 50%;
  display: none;
}
#cartBtn {font-size: 14px;font-weight:bold; position:fixed; bottom:80px; left:20px; background:#d62828; color:white; border:none; border-radius:50px; width:60px; height:60px; font-size:24px; cursor:pointer; z-index:2000; }
body {padding-top:55px;  padding-bottom:90px; margin:0; font-family:Tahoma; background:#f5f5f5 }
.top-bar button {
  background:none;
  border:none;
  color:#630404;
  font-size:25px;
  font-weight:bold;
  cursor:pointer;
}
.top-bar {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:55px;
  background:#d6d6d6;
  color:#630404;
  display:flex;
  z-index:2000;
}
/* Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.header-img {
  width:100%;
  height:330px;
  object-fit:contain;
}

/* Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù */
.item-name {
  font-size:24px;
  font-weight:bold;
  margin:10px;
}
.item-details {
  font-size:17px;
  font-weight:normal;
  margin:10px;
  color: rgba(116, 112, 112, 0.795)
}

.siz{font-size: 16px; color: rgba(116, 112, 112, 0.795);padding: 7px;}
.sizword{font-size: 10px; color: #630404;background-color: #d6adad;border-radius: 30px;padding:3px 7px  ;}
/* Ø§Ù„ÙˆØ­Ø¯Ø§Øª */
.units {
    display:grid;
  gap:12px;
  padding:10px;
}

.units[data-count="1"] { grid-template-columns: 1fr; }
.units[data-count="2"] { grid-template-columns: repeat(2, 1fr); }
.units[data-count="3"] { grid-template-columns: repeat(3, 1fr); }
.units[data-count="4"] { grid-template-columns: repeat(3, 1fr); }
.units[data-count="5"],
.units[data-count="6"] {  grid-template-columns: repeat(3, 1fr);}

.unit {
  text-align: center;
  border-radius:20px;
  padding:8px;
  cursor:pointer;
  border:2px solid transparent;
  transition:0.2s;
  }

.unit.selected img{
  border-color:#d62828;
  background:#d62828;
}

.unit img {
  text-align: center;
  width: 55px;
  object-fit:contain;
  border-radius:100vh;
}

.unit-name { font-weight:bold; margin-top:6px; text-align:center;font-size: 20px;}
.unit-price { color:#007706; font-weight:normal; text-align:center ;font-size: 18px;}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
.bottom-bar {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  box-shadow: silver 50px;
  shape-outside: 10px;
  padding:10px;
  display:flex;
  justify-content:space-around;
  align-items:center;
  gap:10px;
  z-index: 9999; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„ØµÙˆØ± */

}

.bottom-bar button {
  background:#d62828;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  font-size:16px;
  font-weight:bold;  margin-right: 15px;
  cursor:pointer;
}
.add-cart-btn {
    position: relative;
    overflow: hidden;   /* Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ù†ÙŠÙ…Ø´Ù† Ù…Ø§ ÙŠØ·Ù„Ø¹Ø´ Ø¨Ø±Ø§ Ø§Ù„Ø²Ø± */
    background: #d62828;
    color: white;
    border: none;
    padding: 14px 28px;
    font-size: 16px;
    border-radius: 12px;
    cursor: pointer;
}
/* Ø·Ø¨Ù‚Ø© Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
.add-cart-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: #ffffff;
    z-index: 1;
}

/* Ø§Ù„Ù†Øµ ÙÙˆÙ‚ Ø§Ù„Ø£Ù†ÙŠÙ…Ø´Ù† */
.add-cart-btn span {
    position: relative;
    z-index: 2;
}

/* ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…Ø´Ù† */
.add-cart-btn.animate::before {
    animation: wipeFill 1.0s ease-in-out;
}

/* Ø§Ù„Ø­Ø±ÙƒØ© */
@keyframes wipeFill {
    0%   { left: -100%; }
    50%  { left: 0; }
    100% { left: 100%; }

}
button { font-size:14px; font-weight:bold; padding:5px 10px; border:none; border-radius:6px; cursor:pointer; background:#d62828; color:#fff; margin:2px; }
button:hover { background:#ff6f3c; }
.qty {
  font-size:18px;
  font-weight:bold;
  min-width:30px;
  text-align:center;
  padding-right: 15px;
}
</style>
<div class="top-bar" style="align-items: center; justify-content: space-between;" >
<h2 style="font-size: 14px; padding-right: 10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ†Ù</h2>
    <button onclick="goBack()"> â† </button>
  
</div>
</head>
<body>
<button id="cartBtn" onclick="goToCart()">ğŸ›’  <span id="cartBadge" class="badge"></span>
</button>
<img id="mainImg" class="header-img">
<div  style="display: flex;align-items: center;padding-left:10px ; justify-content: space-between;">
<div id="itemName" class="item-name"></div>
<div id="itemPrice" class="item-Price"></div>
</div>
<div id="itemdetails" class="item-details"></div>
<div id="siz" class="siz">Ø§Ù„Ø­Ø¬Ù… <span class="sizword">* Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯</span></div>

<div id="unitsBox" class="units"></div>
<h3 id="addspan" class="addspan" style="margin-top:20px">Ø¥Ø¶Ø§ÙØ§Øª</h3><br><br>
<div id="addonsBox" class="addons-grid"></div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠ -->
<div class="bottom-bar">
  <button onclick="changeQty(-1)">-</button> <!--â–â•-->
  <span id="qty" class="qty">0</span>
  <button onclick="changeQty(1)">+</button>

  <button class="add-cart-btn" style="flex:1" onclick="animateAdd(this)">
  <span>  Ø£Ø¶Ù Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ø© </span>
  </button>
</div>

<script src="cart-storage.js"></script>
<script>
let CART = loadCart(); // âœ… Ø¨Ø¯ÙˆÙ† timeout

</script>

<script>
// =======================
// CART
// =======================
function saveCart(){
    const data = {
        cart: CART,
        time: Date.now()
    };
    localStorage.setItem("CART_SESSION", JSON.stringify(data));
}

// =======================
// LOAD ITEM
// =======================
const raw = localStorage.getItem("selectedItem");
if (!raw) location.href = "index.html";

const data = JSON.parse(raw);

// =======================
// ITEM INFO
// =======================
const imgSrc = data.item.itemImg?.length > 50
    ? `data:image/jpeg;base64,${data.item.itemImg}`
    : "noimage.png";

document.getElementById("mainImg").src = imgSrc;
document.getElementById("itemName").textContent = data.item.nameA;
document.getElementById("itemPrice").textContent =Number( data.units[0].price).toFixed(2) + ' Ø¬';
document.getElementById("itemdetails").textContent =
    "Ø¬ÙˆØ¹Ø§Ù†ØŸ " + data.item.nameA + " Ù…Ù† Ø§ÙØ¶Ù„ Ø§Ù„Ø§Ø·Ø¹Ù…Ù‡ Ø§Ù„ØªÙŠ ØªÙ†ØªØ¸Ø±Ùƒ Ù„ØªØ¬Ø±Ø¨Ù‡Ø§";
// =======================
// STATE
// =======================
let selectedUnit = null;
let basePrice = 0;         // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©
let qty = 1;


const units = data.units || [];
const unitsBox = document.getElementById("unitsBox");
const siz = document.getElementById("siz");
// =======================
// UNITS LOGIC
// =======================
// =======================
// ADDONS DATA
// =======================
const ADDONS = [
  {
    id: 1,
    categoryIds: [1],
    name: "Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø·Ù…Ø§Ø·Ù…",
    price: 5,
    img: "tomatos.png"
  },  
  {
    id: 2,
    categoryIds: [1, 2],
    name: "Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø®ÙŠØ§Ø±",
    price: 3,
    img: "qer.png"
  }
];

// ğŸŸ¢ Ø­Ø§Ù„Ø© ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
if (units.length === 1) {
    selectedUnit = units[0];

    qty = 1;

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    unitsBox.style.display = "none";
    siz.style.display = "none";

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©
    document.getElementById("qty").textContent = qty;
}

// ğŸŸ¡ Ø£ÙƒØªØ± Ù…Ù† ÙˆØ­Ø¯Ø©
else if (units.length > 1) {
    renderUnits();
    selectFirstUnit();
    renderAddons(1);
}
// =======================
// RENDER UNITS
// =======================
function renderUnits() {
    unitsBox.innerHTML = "";
    unitsBox.dataset.count = units.length;

    units.forEach(u => {
        const div = document.createElement("div");
        div.className = "unit";
        div.innerHTML = `
            <img src="${imgSrc}">
            <div class="unit-name">${u.unitName}</div>
            <div class="unit-price">${u.price} Ø¬Ù†ÙŠÙ‡</div>
        `;

        div.onclick = () => selectUnit(u, div);
        unitsBox.appendChild(div);
    });
}

// =======================
// SELECT UNIT
// =======================
function selectUnit(unit, el) {
    document.querySelectorAll(".unit").forEach(u =>
        u.classList.remove("selected")
    );

    el.classList.add("selected");
    selectedUnit = unit;
    basePrice = Number(unit.price);

    updateItemPrice();

  }

// =======================
// AUTO SELECT FIRST UNIT
// =======================
function selectFirstUnit() {
    const first = document.querySelector(".unit");
    if (!first) return;

    first.classList.add("selected");
    selectedUnit = units[0];
        basePrice = Number(units[0].price);

    qty = 1;

    document.getElementById("qty").textContent = qty;
}

function changeQty(delta){
  if(!selectedUnit) return alert("Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹");
  qty += delta;
      updateItemPrice();
  if(qty < 1) qty = 1;
  document.getElementById("qty").textContent = qty;
        document.getElementById("itemPrice").textContent =Number( qty * selectedUnit.price).toFixed(2) + ' Ø¬';
     updateItemPrice();

}
function sendToCart(){
    if(!selectedUnit){
        alert("Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©");
        return;
    }
        const addonsTotal = getAddonsTotal();
// ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const payload = {
        itemId: data.item.id,
        itemName: data.item.nameA,
        unitName: selectedUnit.unitName,
        price: selectedUnit.price,
        qty: qty,   // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        addons: SELECTED_ADDONS,
        addonsTotal: addonsTotal,
        img: imgSrc
    };

    const addonsKey = addonsSignature(payload.addons);
payload.addonsKey = addonsKey; // Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡
const key = `${payload.itemId}-${payload.unitName}-${addonsKey}`;
//CART[key] = CART[key] ? {...payload, qty: CART[key].qty + payload.qty} : payload;
    // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ CART
    if(!CART[key]){
        CART[key] = payload;
        cartEffect();
    } else {
        // Ø¥Ø°Ø§ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ù†Ø¬Ù…Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
        CART[key].qty += payload.qty;
        cartEffect();
    }

    // Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø©
    saveCart();

    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ø±Øª (Ø£Ùˆ index.html)
//    window.location.href = "cart.html"; // Ø£Ùˆ "index.html" Ø­Ø³Ø¨ Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ø±Øª
}

function goBack(){
  window.addEventListener("pageshow", () => {
    let CART = loadCart(); // âœ… Ø¨Ø¯ÙˆÙ† timeout

    if(typeof renderCart === "function") renderCart();
});
  
  history.back();
  }
function sendToCart1(){
  if(!selectedUnit){
    alert("Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©");
    return;
  }

  // ØªØ¬Ù‡ÙŠØ² Ù†ÙØ³ Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ù„ÙŠ index Ù…ØªØ¹ÙˆØ¯ Ø¹Ù„ÙŠÙ‡Ø§
  const payload = {
    itemId: data.item.id,
    itemName: data.item.nameA,
    unitName: selectedUnit.unitName,
    price: selectedUnit.price,
    qty: qty,
    img: data.item.itemImg
  };

  // Ù†Ø®Ø²Ù†Ù‡Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§
  localStorage.setItem("ADD_TO_CART", JSON.stringify(payload));

  // Ø±Ø¬ÙˆØ¹ Ù…Ø¨Ø§Ø´Ø± Ù„ØµÙØ­Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  window.location.href = "index.html";

}
function goToCart(){
    // Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø±Øª ÙÙŠ localStorage (Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹)
    saveCart();
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ø±Øª
    window.location.href = "cart.html";
}
function markCartChanged() {
  const badge = document.getElementById("cartBadge");
  badge.style.display = "block";
}
function animateCart() {
  const btn = document.getElementById("cartBtn");
  btn.classList.add("cart-animate");
  setTimeout(() => btn.classList.remove("cart-animate"), 400);
}
function cartEffect() {
  markCartChanged();
  animateCart();
}
function animateAdd(btn) {
    btn.classList.remove("animate");
    void btn.offsetWidth; // restart animation
    btn.classList.add("animate");

    // Ù‡Ù†Ø§ ØªØ­Ø· ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
    sendToCart();
}

function renderAddons(categoryId) {
    const box = document.getElementById("addonsBox");
    if (!box) return;

    box.innerHTML = "";

    const filtered = ADDONS.filter(a =>
        a.categoryIds.includes(categoryId)
    );

    filtered.forEach(addon => {
        const card = document.createElement("div");
        card.className = "addon-card";

        card.innerHTML = `
            <div class="addon-img">
                <img src="${addon.img}">
            </div>
            <div class="addon-body">
                <div class="addon-name">${addon.name}</div>
                <div class="addon-price">+ ${addon.price.toFixed(2)} Ø¬</div>
            </div>
        `;

        card.onclick = () => toggleAddon(addon, card);
        box.appendChild(card);
    });
}

let SELECTED_ADDONS = [];

function getAddonsTotal() {
    return SELECTED_ADDONS.reduce((sum, a) => sum + Number(a.price), 0);
}
function updateItemPrice(){
    if(!selectedUnit) return;

    const addonsTotal = getAddonsTotal();
    const finalPrice =(
        Number(selectedUnit.price) + Number(addonsTotal)) * qty;

    document.getElementById("itemPrice").textContent =
        finalPrice.toFixed(2) + " Ø¬";
}

function toggleAddon(addon, el) {
    const exists = SELECTED_ADDONS.find(a => a.id === addon.id);

    if (exists) {
        // Ø¥Ø²Ø§Ù„Ø©
        SELECTED_ADDONS = SELECTED_ADDONS.filter(a => a.id !== addon.id);
        el.classList.remove("selected");
    } else {
        // Ø¥Ø¶Ø§ÙØ©
        SELECTED_ADDONS.push(addon);
        el.classList.add("selected");
    }

    updateItemPrice(); // ğŸ”¥ ØªØ¬Ù…ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±
}
function addonsSignature(addons){
    if(!addons || addons.length === 0) return "noaddons";

    return addons
        .map(a => a.id) // Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ Ù…ÙÙŠØ´ id
        .sort()
        .join("_");
}
</script>


</body>
</html>
